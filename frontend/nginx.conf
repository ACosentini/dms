server {
    listen 80;
    
    # Add debug logging
    error_log /var/log/nginx/error.log debug;
    access_log /var/log/nginx/access.log;
    
    # Simplified health check for backend
    location = /check-backend {
        default_type text/html;
        return 200 '<html><body><h1>Backend Health Check</h1><div id="results">Checking...</div><script>
            async function checkUrl(url) {
                try {
                    const start = new Date().getTime();
                    const response = await fetch(url);
                    const elapsed = new Date().getTime() - start;
                    return {
                        url: url,
                        status: response.status,
                        success: response.ok,
                        time: elapsed + "ms"
                    };
                } catch (error) {
                    return { url: url, error: error.message, success: false };
                }
            }
            
            async function runChecks() {
                const baseUrl = "${BACKEND_URL}";
                document.getElementById("results").innerHTML = "Testing connections to " + baseUrl + "...";
                
                const urls = [
                    baseUrl,
                    baseUrl + "/actuator/health",
                    baseUrl + "/api/actuator/health", 
                    baseUrl + "/auth/login",
                    baseUrl + "/api/auth/login",
                    baseUrl + "/api/hello"
                ];
                
                let html = "<h2>Results:</h2><ul>";
                for (const url of urls) {
                    const result = await checkUrl(url);
                    html += "<li>" + url + ": " + 
                        (result.success ? "✓" : "✗") + " " +
                        (result.status || "") + " " +
                        (result.error || "") + "</li>";
                }
                html += "</ul><p>Tested at: " + new Date().toISOString() + "</p>";
                html += "<button onclick=\"runChecks()\">Refresh</button>";
                
                document.getElementById("results").innerHTML = html;
            }
            
            runChecks();
        </script></body></html>';
    }
    
    location / {
        root /usr/share/nginx/html;
        index index.html index.htm;
        try_files $uri $uri/ /index.html;
    }
    
    # Special handling for the auth login endpoint
    location = /api/auth/login {
        # Use the backend URL directly without protocol conversion
        set $backend_url "${BACKEND_URL}";
        
        # Basic headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Disable SSL verification while maintaining HTTPS connection
        proxy_ssl_verify off;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # DNS resolver
        resolver 8.8.8.8 valid=300s;
        resolver_timeout 10s;
        
        # Disable redirects
        proxy_redirect off;
        
        # Debug headers to help troubleshoot
        add_header X-Debug-Target "${BACKEND_URL}/api/auth/login" always;
        
        # Use HTTPS since that's what works in the browser
        proxy_pass ${BACKEND_URL}/api/auth/login;
    }
    
    # Generic API handling for all other endpoints
    location /api/ {
        # Use the backend URL directly
        set $backend_url "${BACKEND_URL}";
        
        # Basic headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Disable SSL verification while maintaining HTTPS connection
        proxy_ssl_verify off;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # DNS resolver
        resolver 8.8.8.8 valid=300s;
        resolver_timeout 10s;
        
        # Disable redirects
        proxy_redirect off;
        
        # Debug headers to help troubleshoot
        add_header X-Debug-Backend "${BACKEND_URL}" always;
        add_header X-Debug-Path "/api/" always;
        
        # Use HTTPS since that's what works in the browser
        # Keep the /api/ prefix intact
        proxy_pass ${BACKEND_URL}/api/;
    }
} 